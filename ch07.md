# 07 Promise와 async/await 구문

# 07-1 비동기 콜백 함수

이번 장은 node.js가 제공하는 readFile과 같은 비동기 API를 예로 들고 있음.
타입스크립트에서 readFile 같은 node.js API를 사용하려면 tsconfig.json파일에 별도의 설정이 필요. 따라서 이번 장의 예제 소스를 동작시키려면 node.js프로젝트 설정이 필요

## 실습 프로젝트 설정

```shell
mkdir ch07-1
ch ch07-1
npm init --y
npm i -D typescript ts-node @types/node
mkdir src
```
이전 장 tsconfig.json 복사하거나 tsc --init 명령으로 파일 생성.
tsconfig.json에 downloadIteration 항목을 true 로 설정

## 동기와 비동기 API

node.js는 파일 시스템(file system)과 관련된 기능을 모아둔 fs패키지 제공.
fs패키지는 같은 기능을 '동기(synchronous)'와 '비동기(ansynchronous)'버전으로 나누어 제공.
예를 들어 파일을 읽는 기능은 동기 버전인 **readFileSync**와 비동기 버전인 **readFile** 제공.

```typescript
import { readFileSync, readFile } from "fs";

// package.json파일을 동기 방식으로 읽는 예
console.log('read package.json using synchronous api ...')
const buffer: Buffer = readFileSync('./package.json')
console.log(buffer.toString())

// package.json 파일을 비동기 방식으로 읽는 예
readFile('./package.json', (error: Error, buffer: Buffer) => {
  console.log('read package.json using ansynchronous api ...')
  console.log(buffer.toString())
})

// Promise와 async/await 구문을 사용한 예
const readFilePromise = (filename: string): Promise<string> => 
  new Promise<string>((resolve, reject) => {
    readFile(filename, (error: Error, buffer: Buffer) => {
      if(error)
        reject(error)
      else 
        resolve(buffer.toString())
    })
  });

  (async () => {
    const content = await readFilePromise('./package.json')
    console.log('read package.json using Promise and async.awiat ...')
    console.log(content)
  })()
```

운영체제가 제공하는 서비스를 API라고 함.
API는 타입스크립트와 같은 프로그래밍 언어의 함수 형태로 제공됨. 그런데 API함수는 일반 함수와 달리 하드디스크에 저장된 파일을 읽는 등 실행 시 물리적인 시간이 소요됨.

따라서 파일 내용을 모두 읽을 때까지 프로그램 동작을 잠시 멈추는 동기 방식의 API와 프로그램의 동작을 멈추지 않는 대신 결과를 콜백 함수로 얻게 하는 비동기 방식의 API를 제공함. 즉, 똑같은 기능을 대상으로 두 가지 방식의 API를 제공.

비동기 API의 콜백 함수를 특별히 '비동기 콜백 함수'라고 함
비동기 콜백 함수는 일반 함수와 달리 API의 물리적인 동작 결과를 수신하는 목적으로만 사용.

## readFileSync와 readFile API

웹 브라우저와 달리 node.js는 운영체제 파일 시스템에 있는 파일을 읽을 수 있음.
node.js에서 파일 읽기는 readFileSync라는 이름의 API를 사용해서 구현.
readFileSync는 파일을 읽어서 Buffer라는 타입으로 전달해줌.

```typescript
import {readFileSync} from 'fs'
readFileSync(path: string): Buffer
```
Buffer는 node.js가 제공하는 클래스로서 바이너리 데이터를 저장하는 기능을 수행.
Buffer의 데이터를 문자열로 만들려고 할 때는 Buffer의 toString 메서드를 사용.

동기 방식 API는 작업이 종료될 때까지 프로그램을 일시적으로 멈추게 하는 특징이 있음.

```typescript
import { readFileSync } from "fs";

//package.json 파일의 바이너리 내용
const buffer: Buffer = readFileSync("./package.json");
const content: string = Buffer.toString();
console.log(content);
```

비동기 버전 readFile 제공.

```typescript
import {readFile} from 'fs'
readFile(파일경로, 콜백함수: ( error: Error, buffer: Buffer) => void)
```

```typescript
import { readFile } from "fs";

readFile('./package.json', (err: Error, buffer: Buffer)=> {
  if(err) throw err // 오류 발샐 시 처리 코드
  else {
    const content: string = buffer.toString();
    console.log(content)
  }
})
```

## 단일 스레드와 비동기 API

자바스크립트는 단일 스레드(single-thread)로 동작하므로 될 수 있으면 readFileSync와 같은 동기 API를 사용하지 말아야 함.
타입스크립트 또한 ES5 자바스크립트로 변환되어 실행되므로 자바스크립트와 마찬가지로 될 수 있으면 동기 API를 사용하지 말아야 함.

- 단일 스레드로 동작하는 자바스크립트
> 스레드는 CPU가 프로그램을 동작시키는 최소 단위.
> 운영체제가 프로그램이 실행되고 있는 상태일 때를 프로세스라고 함. 
> 프로세스는 한 개의 주 스레드와 여러 개의 작업 스레드를 동작 시킴.
> 자바스크립트 코드는 항상 한 개의 작업 스레드에서 실행됨.
> 웹 브라우저나 node.js프로그램 자체는 다중 스레드로 동작하지만, 자바스크립트 코드는 항상 한개의 작업 스레드, 즉 단일 스레드에서 동작

## 콜백 지옥

비동기 API를 사용하면 콜백 함수에서 다시 또 다른 비동기 API를 호출하는 코드를 만들 때 코드가 매우 복잡해짐.

```typescript
import { readFile } from "fs"

readFile('./package.json',(err:Error, buffer: Buffer) => {
  if(err) throw err
  else {
    const content: string = buffer.toString()
    console.log(content)

    readFile('./tsconfig.json',(err:Error, buffer: Buffer) => {
      if(err) throw err
      else {
        const content: string = buffer.toString()
        console.log(content)
      }
    })
  }
})
```

- 자동 세미콜론 삽입 기능이란?
> 자바스크립트와 타입스크립트 문법에는 자동 세미콜론 삽입(automatic semicolon insertion, ASI)이라는 원칙이 있음.
> ASI는 세미콜론이 생략되면 자동으로 세미콜론을 삽입해 주는 컴파일러의 기능
> 그런데 ASI 기능이 적용되지 않는 다음 3가지 경우가 있음 
> 1. 문장이 '('기호로 시작될 때
> 2. 문장이 '['기호로 시작될 때
> 3. 문장이 역따옴표'`'로 시작될 때
